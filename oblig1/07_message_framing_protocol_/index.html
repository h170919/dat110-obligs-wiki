
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../06_messaging_connection_/" rel="prev"/>
<link href="../oblig1_index/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.12" name="generator"/>
<title>Chapter 7: Message Framing Protocol - dat110 notes</title>
<link href="../../assets/stylesheets/main.2afb09e1.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#chapter-7-message-framing-protocol">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="dat110 notes" class="md-header__button md-logo" data-md-component="logo" href="../.." title="dat110 notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            dat110 notes
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Chapter 7: Message Framing Protocol
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="dat110 notes" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="dat110 notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    dat110 notes
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Oblig1
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Oblig1
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../01_rpc_client_stub_/">
<span class="md-ellipsis">
    Chapter 1: RPC Client Stub
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../02_rpc_server_implementation__skeleton__/">
<span class="md-ellipsis">
    Chapter 2: RPC Server Implementation (Skeleton)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../03_rpc_client_/">
<span class="md-ellipsis">
    Chapter 3: RPC Client
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../04_rpc_server_/">
<span class="md-ellipsis">
    Chapter 4: RPC Server
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../05_rpc_data_marshalling_unmarshalling_/">
<span class="md-ellipsis">
    Chapter 5: RPC Data Marshalling/Unmarshalling
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../06_messaging_connection_/">
<span class="md-ellipsis">
    Chapter 6: Messaging Connection
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Chapter 7: Message Framing Protocol
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Chapter 7: Message Framing Protocol
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-problem-just-a-stream-of-bytes">
<span class="md-ellipsis">
      The Problem: Just a Stream of Bytes
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-solution-message-framing-protocol-standard-envelopes">
<span class="md-ellipsis">
      The Solution: Message Framing Protocol - Standard Envelopes!
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementing-the-framing-messageutils">
<span class="md-ellipsis">
      Implementing the Framing: MessageUtils
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-whole-picture">
<span class="md-ellipsis">
      The Whole Picture
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../oblig1_index/">
<span class="md-ellipsis">
    Project 1 Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Oblig2
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Oblig2
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/01_message_hierarchy__communication_protocol__/">
<span class="md-ellipsis">
    Chapter 1: Message Hierarchy (Communication Protocol)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/02_client__network_interaction_logic__/">
<span class="md-ellipsis">
    Chapter 2: Client (Network Interaction Logic)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/03_chapp__application_entry_point__/">
<span class="md-ellipsis">
    Chapter 3: Chapp (Application Entry Point)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/04_ui_areas__commandarea___messagearea__/">
<span class="md-ellipsis">
    Chapter 4: UI Areas (CommandArea &amp; MessageArea)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/05_controller__ui_logic_coordinator__/">
<span class="md-ellipsis">
    Chapter 5: Controller (UI Logic Coordinator)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/06_transportmessage__network_data_framing__/">
<span class="md-ellipsis">
    Chapter 6: TransportMessage (Network Data Framing)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/07_connection__network_stream_handling__/">
<span class="md-ellipsis">
    Chapter 7: Connection (Network Stream Handling)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/08_messageutils__serialization_deserialization__/">
<span class="md-ellipsis">
    Chapter 8: MessageUtils (Serialization/Deserialization)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/oblig2_index/">
<span class="md-ellipsis">
    Project 2 Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-problem-just-a-stream-of-bytes">
<span class="md-ellipsis">
      The Problem: Just a Stream of Bytes
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-solution-message-framing-protocol-standard-envelopes">
<span class="md-ellipsis">
      The Solution: Message Framing Protocol - Standard Envelopes!
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementing-the-framing-messageutils">
<span class="md-ellipsis">
      Implementing the Framing: MessageUtils
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-whole-picture">
<span class="md-ellipsis">
      The Whole Picture
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="chapter-7-message-framing-protocol">Chapter 7: Message Framing Protocol</h1>
<p>Welcome to the final chapter! In the <a href="../06_messaging_connection_/">previous chapter</a>, we explored the <strong>Messaging Connection</strong> layer. We saw how it acts like a reliable postal service, providing <code>send</code> and <code>receive</code> methods to exchange <code>Message</code> objects between a client and server. We briefly mentioned that there's some "magic" happening inside <code>send</code> and <code>receive</code> to make sure whole messages are sent and received correctly, even though the underlying network connection (TCP) just sees a continuous stream of bytes.</p>
<p>It's time to reveal that magic! It's called the <strong>Message Framing Protocol</strong>.</p>
<h2 id="the-problem-just-a-stream-of-bytes">The Problem: Just a Stream of Bytes</h2>
<p>Imagine you're reading a very long scroll of text that has no punctuation or spaces between words. It would be incredibly difficult to figure out where one word ends and the next begins, let alone understand the sentences!</p>
<p>TCP network connections are a bit like that scroll. They provide a reliable <em>stream</em> of bytes from the sender to the receiver. If the sender sends "HELLO" (5 bytes) and then immediately sends "WORLD" (5 bytes), the receiver might just get a stream like "HELLOWORLD" (10 bytes). The receiver doesn't automatically know that this was originally two separate messages.</p>
<p>Our <a href="../06_messaging_connection_/">Messaging Connection</a> needs to send and receive distinct <code>Message</code> objects. If the <a href="../03_rpc_client_/">RPC Client</a> sends a request message, and then maybe another one later, the <a href="../04_rpc_server_/">RPC Server</a> needs to be able to receive the <em>first</em> message completely, process it, and <em>then</em> receive the <em>second</em> message completely. How can we add structure to this byte stream?</p>
<h2 id="the-solution-message-framing-protocol-standard-envelopes">The Solution: Message Framing Protocol - Standard Envelopes!</h2>
<p>The solution is to agree on a set of rules – a <strong>protocol</strong> – for how messages are packaged, or <strong>framed</strong>, before being sent over the stream. This ensures the receiver can identify the boundaries of each message.</p>
<p>Think of it like agreeing to always send letters using standard-sized envelopes. Even if you put multiple envelopes into the mailbag one after another, the recipient can easily pick out one envelope, open it, read the letter inside, and then pick out the next envelope.</p>
<p>Our <strong>Message Framing Protocol</strong> defines the "standard envelope" for our system.</p>
<p><strong>Our Specific Protocol:</strong></p>
<p>In this project (<code>dat110-project1-gruppe69</code>), we use a simple framing protocol:</p>
<ol>
<li><strong>Fixed-Size Segments:</strong> All data is sent in fixed-size chunks called <strong>segments</strong>. Each segment is exactly <strong>128 bytes</strong> long.</li>
<li><strong>Length Header:</strong> The very <strong>first byte</strong> of each 128-byte segment is special. It acts as a <strong>header</strong> and tells the receiver the <strong>length</strong> of the actual payload data contained within <em>that segment</em>. This length can be anywhere from 0 to 127 bytes.</li>
<li><strong>Payload:</strong> The actual message data (the bytes from the <code>Message</code> object) follows the length byte.</li>
<li><strong>Padding:</strong> Since the segment <em>must</em> be 128 bytes, but the payload might be shorter (e.g., only 10 bytes), the remaining bytes in the segment after the payload are just <strong>padding</strong>. They are sent but ignored by the receiver.</li>
</ol>
<p>Here's what our 128-byte "envelope" (segment) looks like:</p>
<pre class="mermaid"><code>graph LR
    A[Segment (128 bytes total)] --&gt; B(Byte 1: Length L);
    A --&gt; C(Bytes 2 to L+1: Payload Data);
    A --&gt; D(Bytes L+2 to 128: Padding);
    subgraph Fixed Size Frame
        direction LR
        B --- C --- D;
    end
    style A fill:#f9f,stroke:#333,stroke-width:2px</code></pre>
<ul>
<li>The first byte tells us <code>L</code>, the length of the <em>real</em> data.</li>
<li>The next <code>L</code> bytes are the actual payload we care about.</li>
<li>The rest of the 128 bytes are just filler (padding).</li>
</ul>
<h2 id="implementing-the-framing-messageutils">Implementing the Framing: <code>MessageUtils</code></h2>
<p>The rules of our protocol are implemented in the helper methods of the <code>MessageUtils.java</code> class, specifically <code>encapsulate</code> and <code>decapsulate</code>. These are the methods used internally by <code>MessageConnection</code>'s <code>send</code> and <code>receive</code>.</p>
<p><strong>1. Packing the Envelope (<code>encapsulate</code>)</strong></p>
<p>When <code>MessageConnection.send(message)</code> is called, it needs to take the <code>message</code>'s data and put it into our standard 128-byte envelope format. It uses <code>MessageUtils.encapsulate</code> for this.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/messaging/MessageUtils.java (Encapsulate)</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MessageUtils</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SEGMENTSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span><span class="w"> </span><span class="c1">// Our fixed envelope size</span>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="c1">// Takes the message payload and puts it into a 128-byte segment</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">encapsulate</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span><span class="w"> </span><span class="c1">// Get the raw payload bytes (0-127 bytes)</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">segment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">SEGMENTSIZE</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="c1">// Create the 128-byte empty envelope</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">        </span><span class="c1">// Rule 1: Put the length of the payload in the first byte</span>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="n">segment</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">length</span><span class="p">;</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="c1">// Rule 2: Copy the payload data into the segment, starting from byte 1</span>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="c1">// Rule 3: The rest of 'segment' is padding (already 0s)</span>
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">segment</span><span class="p">;</span><span class="w"> </span><span class="c1">// Return the filled 128-byte envelope</span>
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="c1">// ... decapsulate method ...</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>Let's break it down:
*   It gets the payload <code>data</code> from the <code>Message</code> object. Remember from <code>Message.java</code>, this <code>data</code> is guaranteed to be 127 bytes or less.
*   It creates a brand new byte array called <code>segment</code> that is exactly 128 bytes long.
*   <code>segment[0] = (byte) data.length;</code> This crucial step writes the <em>length</em> of the payload into the very first byte of the segment.
*   <code>System.arraycopy(...)</code> copies the actual payload <code>data</code> into the <code>segment</code>, but it starts copying <em>at index 1</em> (the second byte), leaving the first byte for the length.
*   The method returns the 128-byte <code>segment</code>. This is what <code>MessageConnection</code> actually writes to the network stream.</p>
<p><strong>2. Unpacking the Envelope (<code>decapsulate</code>)</strong></p>
<p>When <code>MessageConnection.receive()</code> is called, it first reads exactly 128 bytes from the network stream (because it knows all messages arrive in 128-byte segments). It then needs to extract the <em>actual</em> payload from this 128-byte segment. It uses <code>MessageUtils.decapsulate</code> for this.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/messaging/MessageUtils.java (Decapsulate)</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Arrays</span><span class="p">;</span><span class="w"> </span><span class="c1">// Used for array copying</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MessageUtils</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="c1">// ... SEGMENTSIZE constant and encapsulate method ...</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="c1">// Takes a 128-byte segment and extracts the original payload data</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="nf">decapsulate</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">segment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">        </span><span class="c1">// Basic checks for valid segment</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">segment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">segment</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SEGMENTSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">           </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">"Invalid segment received"</span><span class="p">);</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">        </span><span class="c1">// Rule 1: Read the payload length from the first byte</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">        </span><span class="c1">// (&amp; 0xFF ensures we treat the byte as unsigned, 0-255)</span>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">segment</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">;</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="c1">// Sanity check: Length shouldn't exceed allowed payload size</span>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SEGMENTSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Max payload is 127</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">             </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">"Segment length field is too large"</span><span class="p">);</span>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>
</span><span id="__span-1-25"><a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">        </span><span class="c1">// Rule 2: Extract the payload data</span>
</span><span id="__span-1-26"><a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">        </span><span class="c1">// Create a new array of the correct size ('length')</span>
</span><span id="__span-1-27"><a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">length</span><span class="o">]</span><span class="p">;</span>
</span><span id="__span-1-28"><a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">        </span><span class="c1">// Copy 'length' bytes from the segment, starting from byte 1</span>
</span><span id="__span-1-29"><a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
</span><span id="__span-1-30"><a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>
</span><span id="__span-1-31"><a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">        </span><span class="c1">// Rule 3: The padding is ignored!</span>
</span><span id="__span-1-32"><a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>
</span><span id="__span-1-33"><a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">        </span><span class="c1">// Create and return a new Message containing only the extracted data</span>
</span><span id="__span-1-34"><a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Message</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-1-35"><a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-36"><a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="p">}</span>
</span></code></pre></div>
<p>Here's how it works:
*   It receives the 128-byte <code>segment</code> that was read from the network.
*   <code>int length = segment[0] &amp; 0xFF;</code> reads the first byte to figure out how long the <em>actual</em> payload is. (The <code>&amp; 0xFF</code> is a technical detail to handle Java's byte representation correctly).
*   It creates a <em>new</em> byte array called <code>data</code> that is exactly <code>length</code> bytes long – just big enough for the payload.
*   <code>System.arraycopy(...)</code> copies <code>length</code> bytes <em>from</em> the received <code>segment</code> (starting at index 1) <em>into</em> the new <code>data</code> array.
*   Finally, it creates a new <code>Message</code> object using only the extracted <code>data</code> and returns it. This <code>Message</code> now contains only the original payload sent by the sender, with the framing and padding removed.</p>
<h2 id="the-whole-picture">The Whole Picture</h2>
<p>So, the <a href="../06_messaging_connection_/">Messaging Connection</a> layer uses this framing protocol like this:</p>
<ol>
<li>
<p><strong>Sender (<code>MessageConnection.send</code>):</strong></p>
<ul>
<li>Gets the <code>Message</code> object (containing payload from, say, <a href="../05_rpc_data_marshalling_unmarshalling_/">RPC Data Marshalling/Unmarshalling</a>).</li>
<li>Calls <code>MessageUtils.encapsulate</code> to wrap the payload in a 128-byte segment with the length header.</li>
<li>Writes the entire 128-byte segment to the TCP output stream.</li>
</ul>
</li>
<li>
<p><strong>Receiver (<code>MessageConnection.receive</code>):</strong></p>
<ul>
<li>Reads exactly 128 bytes from the TCP input stream (because it expects a segment).</li>
<li>Calls <code>MessageUtils.decapsulate</code> on the received 128-byte segment.</li>
<li><code>decapsulate</code> reads the length header, extracts the payload bytes, and ignores the padding.</li>
<li><code>decapsulate</code> returns a new <code>Message</code> object containing only the original payload.</li>
<li><code>receive</code> returns this payload-only <code>Message</code> object to the caller (e.g., the <a href="../04_rpc_server_/">RPC Server</a>).</li>
</ul>
</li>
</ol>
<p>This ensures that even though TCP is just a stream, the <code>MessageConnection</code> layer can reliably send and receive distinct messages because the <strong>Message Framing Protocol</strong> provides the necessary structure.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The <strong>Message Framing Protocol</strong> is a fundamental concept in network programming. It defines the rules for how to structure data sent over a stream-based connection so that the receiver can distinguish individual messages. In our project, we use a simple fixed-size segment protocol: every message travels inside a 128-byte "envelope," where the first byte declares the length of the actual content inside (0-127 bytes), and the rest is potential padding.</p>
<p>The <code>MessageUtils.encapsulate</code> and <code>MessageUtils.decapsulate</code> methods implement this protocol, allowing our <a href="../06_messaging_connection_/">Messaging Connection</a> layer to provide a clean <code>send(Message)</code> and <code>receive()</code> interface to the higher RPC layers.</p>
<p>With this final piece, we've explored the entire stack, from the high-level convenience of RPC Stubs down to the details of packaging bytes for reliable network transmission. Congratulations on completing the tutorial for <code>dat110-project1-gruppe69</code>!</p>
<hr/>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
</body>
</html>