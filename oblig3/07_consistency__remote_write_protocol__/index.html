
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../06_message_/" rel="prev"/>
<link href="../08_distributed_mutual_exclusion_/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.12" name="generator"/>
<title>Chapter 7: Consistency (Remote-Write Protocol) - dat110 notes</title>
<link href="../../assets/stylesheets/main.2afb09e1.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#chapter-7-consistency-remote-write-protocol">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="dat110 notes" class="md-header__button md-logo" data-md-component="logo" href="../.." title="dat110 notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            dat110 notes
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Chapter 7: Consistency (Remote-Write Protocol)
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="dat110 notes" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="dat110 notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    dat110 notes
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Oblig1
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Oblig1
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/01_rpc_client_stub_/">
<span class="md-ellipsis">
    Chapter 1: RPC Client Stub
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/02_rpc_server_implementation__skeleton__/">
<span class="md-ellipsis">
    Chapter 2: RPC Server Implementation (Skeleton)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/03_rpc_client_/">
<span class="md-ellipsis">
    Chapter 3: RPC Client
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/04_rpc_server_/">
<span class="md-ellipsis">
    Chapter 4: RPC Server
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/05_rpc_data_marshalling_unmarshalling_/">
<span class="md-ellipsis">
    Chapter 5: RPC Data Marshalling/Unmarshalling
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/06_messaging_connection_/">
<span class="md-ellipsis">
    Chapter 6: Messaging Connection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/07_message_framing_protocol_/">
<span class="md-ellipsis">
    Chapter 7: Message Framing Protocol
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/oblig1_index/">
<span class="md-ellipsis">
    Project 1 Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Oblig2
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Oblig2
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/00_index/">
<span class="md-ellipsis">
    Tutorial: dat110-oblig2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/01_client_/">
<span class="md-ellipsis">
    Chapter 1: Client
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/02_broker_/">
<span class="md-ellipsis">
    Chapter 2: Broker
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/03_message_/">
<span class="md-ellipsis">
    Chapter 3: Message
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/04_messagetype_/">
<span class="md-ellipsis">
    Chapter 4: MessageType
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/05_messageutils_/">
<span class="md-ellipsis">
    Chapter 5: MessageUtils
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/06_connection_/">
<span class="md-ellipsis">
    Chapter 6: Connection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/07_dispatcher_/">
<span class="md-ellipsis">
    Chapter 7: Dispatcher
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/08_storage_/">
<span class="md-ellipsis">
    Chapter 8: Storage
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/09_clientsession_/">
<span class="md-ellipsis">
    Chapter 9: ClientSession
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/10_stopable_/">
<span class="md-ellipsis">
    Chapter 10: Stopable
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Oblig3
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Oblig3
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../01_file_management___replication_/">
<span class="md-ellipsis">
    Chapter 1: File Management &amp; Replication
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../02_node__peer__/">
<span class="md-ellipsis">
    Chapter 2: Node (Peer)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../03_remote_communication__rmi__/">
<span class="md-ellipsis">
    Chapter 3: Remote Communication (RMI)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../04_hashing___id_space_/">
<span class="md-ellipsis">
    Chapter 4: Hashing &amp; ID Space
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../05_chord_protocol__ring__lookup__stabilization__/">
<span class="md-ellipsis">
    Chapter 5: Chord Protocol (Ring, Lookup, Stabilization)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../06_message_/">
<span class="md-ellipsis">
    Chapter 6: Message
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Chapter 7: Consistency (Remote-Write Protocol)
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Chapter 7: Consistency (Remote-Write Protocol)
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-problem-keeping-copies-in-sync">
<span class="md-ellipsis">
      The Problem: Keeping Copies in Sync
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-concept-the-remote-write-primary-copy-strategy">
<span class="md-ellipsis">
      Key Concept: The Remote-Write (Primary Copy) Strategy
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#using-the-remote-write-protocol">
<span class="md-ellipsis">
      Using the Remote-Write Protocol
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#internal-implementation-how-the-update-spreads">
<span class="md-ellipsis">
      Internal Implementation: How the Update Spreads
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#what-about-simultaneous-updates">
<span class="md-ellipsis">
      What About Simultaneous Updates?
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../08_distributed_mutual_exclusion_/">
<span class="md-ellipsis">
    Chapter 8: Distributed Mutual Exclusion
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../oblig3_index/">
<span class="md-ellipsis">
    Project 3 Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-problem-keeping-copies-in-sync">
<span class="md-ellipsis">
      The Problem: Keeping Copies in Sync
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-concept-the-remote-write-primary-copy-strategy">
<span class="md-ellipsis">
      Key Concept: The Remote-Write (Primary Copy) Strategy
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#using-the-remote-write-protocol">
<span class="md-ellipsis">
      Using the Remote-Write Protocol
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#internal-implementation-how-the-update-spreads">
<span class="md-ellipsis">
      Internal Implementation: How the Update Spreads
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#what-about-simultaneous-updates">
<span class="md-ellipsis">
      What About Simultaneous Updates?
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="chapter-7-consistency-remote-write-protocol">Chapter 7: Consistency (Remote-Write Protocol)</h1>
<p>Welcome to Chapter 7! In the <a href="../06_message_/">previous chapter</a>, we learned about the <code>Message</code> structure, a standardized way to package information when nodes communicate or store file metadata. We saw that each <a href="../02_node__peer__/">Node (Peer)</a> keeps track of the file replicas it stores using these <code>Message</code> objects.</p>
<p>Now, remember from <a href="../01_file_management___replication_/">Chapter 1</a> that we make multiple copies (replicas) of each file and store them on different nodes for safety. But this creates a new challenge: what happens if someone updates the file? If we change the content of "my_notes.txt" on one node, how do we make sure all the other copies get the same changes? If we don't keep them synchronized, different users might see different versions of the file, leading to confusion!</p>
<p>This chapter introduces a strategy called the <strong>Remote-Write Protocol</strong> (a type of Primary-Copy protocol) to solve this problem and maintain <strong>Consistency</strong> among replicas.</p>
<p><strong>What You'll Learn:</strong></p>
<ul>
<li>Why keeping replicas consistent after updates is important.</li>
<li>The "Primary Copy" strategy (Remote-Write Protocol).</li>
<li>How to find the primary replica for a file.</li>
<li>How updates are sent to the primary and then broadcast to other replicas.</li>
</ul>
<h2 id="the-problem-keeping-copies-in-sync">The Problem: Keeping Copies in Sync</h2>
<p>Imagine you and your friends are working together on a shared digital document, like a presentation slide. To make sure the work isn't lost if one computer crashes, the system automatically saves copies of the slide on several different computers (our <a href="../02_node__peer__/">Nodes (Peers)</a>).</p>
<p>Now, you decide to change the title on your copy of the slide. If <em>only</em> your copy is updated, your friends looking at their copies won't see the new title! Their copies are now <em>inconsistent</em> with yours. We need a rule or procedure to ensure that when one copy is updated, all other copies are eventually updated too.</p>
<h2 id="key-concept-the-remote-write-primary-copy-strategy">Key Concept: The Remote-Write (Primary Copy) Strategy</h2>
<p>The Remote-Write protocol uses a simple but effective strategy: designate one specific copy of the file as the "master" or <strong>Primary</strong> replica. All other copies are considered <strong>Secondary</strong> replicas.</p>
<p>Here's how it works, using our shared document analogy:</p>
<ol>
<li><strong>Designate a Master Copy:</strong> One office (Node) holding a copy of the document is marked as having the "Master Copy" (Primary Replica). The <code>FileManager</code> did this randomly when distributing the file (remember the <code>isPrimary</code> flag in <code>saveFileContent</code> from Chapter 1?).</li>
<li><strong>Updates Go to the Master:</strong> Anyone wanting to change the document <em>must</em> send their proposed changes <em>only</em> to the office holding the Master Copy (the Primary Node). They are not allowed to change their local secondary copies directly.</li>
<li><strong>Master Updates Itself:</strong> The Primary Node first updates its own Master Copy with the changes.</li>
<li><strong>Master Tells Others:</strong> After updating itself, the Primary Node sends a message to <em>all</em> other offices (Secondary Nodes) that have a copy, telling them: "Update your copy with these changes!"</li>
<li><strong>Secondaries Update:</strong> Each Secondary Node receives the update instruction from the Primary and updates its local copy accordingly.</li>
</ol>
<p>This way, all updates are channeled through the Primary, which ensures the changes are applied consistently across all replicas.</p>
<h2 id="using-the-remote-write-protocol">Using the Remote-Write Protocol</h2>
<p>Let's see how a user (interacting via the <code>FileManager</code>) would update a file using this protocol. Suppose we want to update the content of "my_notes.txt".</p>
<p><strong>Step 1: Find the Primary Node</strong></p>
<p>First, the <code>FileManager</code> needs to know which node holds the primary replica for "my_notes.txt". It already knows how to find all nodes holding replicas using <code>requestActiveNodesForFile</code> (from Chapter 1), which returns a set of <code>Message</code> objects. Each <code>Message</code> object has an <code>isPrimaryServer()</code> flag.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// --- In FileManager or user application code ---</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="c1">// Assume we already have the set of active nodes for "my_notes"</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="c1">// Set&lt;Message&gt; activeNodes = fileManager.requestActiveNodesForFile("my_notes");</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">NodeInterface</span><span class="w"> </span><span class="n">primaryNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="n">Set</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">replicas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fileManager</span><span class="p">.</span><span class="na">getActiveNodesforFile</span><span class="p">();</span><span class="w"> </span><span class="c1">// Get the set of replica locations</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replicas</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">replicas</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="c1">// Loop through the Message objects describing each replica</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">replicaInfo</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">replicas</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">        </span><span class="c1">// Check the flag we learned about in Chapter 6!</span>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replicaInfo</span><span class="p">.</span><span class="na">isPrimaryServer</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Found primary replica on node: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">replicaInfo</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">());</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">            </span><span class="c1">// Use the utility from Chapter 3 to get an RMI stub for the primary</span>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">            </span><span class="n">primaryNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">getProcessStub</span><span class="p">(</span><span class="n">replicaInfo</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">(),</span><span class="w"> </span><span class="n">replicaInfo</span><span class="p">.</span><span class="na">getPort</span><span class="p">());</span>
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// Found it, stop searching</span>
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="p">}</span>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primaryNode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Error: Could not find the primary node for the file!"</span><span class="p">);</span>
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="c1">// Handle error...</span>
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em> The code iterates through the <code>Set&lt;Message&gt;</code> called <code>replicas</code>. Each <code>Message</code> describes a node holding a copy. It checks the <code>isPrimaryServer()</code> boolean flag inside each <code>Message</code>. When it finds the one where this flag is <code>true</code>, it uses <code>Util.getProcessStub</code> (our RMI lookup tool from <a href="03_remote_communication__rmi_.md">Chapter 3</a>) to get a connection (stub) to that primary node and stores it in <code>primaryNode</code>.</p>
<p><strong>Step 2: Send Update Request to the Primary</strong></p>
<p>Now that we have the <code>primaryNode</code> stub, we can send the new file content to it. We don't send it to any other nodes. The <code>NodeInterface</code> has a specific method for this: <code>requestRemoteWriteOperation</code>. We need to send the new content (<code>byte[] new_content</code>) and also the full list of all replicas (<code>replicas</code>) so the primary knows who else to notify.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// --- Continuing in FileManager or user application code ---</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1">// Let's say 'new_content' is a byte array with the updated file data</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">new_content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Updated content for my notes."</span><span class="p">.</span><span class="na">getBytes</span><span class="p">();</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="c1">// Make sure we found the primary and have the list of all replicas</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">primaryNode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">replicas</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">replicas</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Sending update request to primary node: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">primaryNode</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">());</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">        </span><span class="c1">// Call the special RMI method on the primary node ONLY</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="n">primaryNode</span><span class="p">.</span><span class="na">requestRemoteWriteOperation</span><span class="p">(</span><span class="n">new_content</span><span class="p">,</span><span class="w"> </span><span class="n">replicas</span><span class="p">);</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Update request sent successfully."</span><span class="p">);</span>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Error sending remote write request: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em> We simply use the <code>primaryNode</code> stub obtained in Step 1 and call the <code>requestRemoteWriteOperation</code> method via RMI. We pass the <code>new_content</code> and the <code>replicas</code> set (which contains <code>Message</code> objects describing all copies, including the primary and secondaries).</p>
<p>This call triggers the primary node to start the update process. The <code>FileManager</code>'s job is now done for initiating the update.</p>
<h2 id="internal-implementation-how-the-update-spreads">Internal Implementation: How the Update Spreads</h2>
<p>What happens after the primary node receives the <code>requestRemoteWriteOperation</code> call?</p>
<p><strong>1. Primary Node Receives the Request (<code>Node.requestRemoteWriteOperation</code>)</strong></p>
<p>The primary node's implementation of this method takes the new content and the list of all replicas. Its main job is to immediately trigger the broadcast of this update to all peers (including itself).</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/middleware/Node.java (Simplified method)</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nd">@Override</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">requestRemoteWriteOperation</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">updates</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activenodes</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Node "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" (Primary): Received remote write request."</span><span class="p">);</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="c1">// Store the list of active nodes needed for broadcasting</span>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">activenodesforfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activenodes</span><span class="p">;</span>
</span><span id="__span-2-9"><a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>
</span><span id="__span-2-10"><a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="c1">// Immediately call the broadcast method (which will update self and others)</span>
</span><span id="__span-2-11"><a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="c1">// Note: 'updater' is an instance of UpdateOperations helper class</span>
</span><span id="__span-2-12"><a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="n">updater</span><span class="p">.</span><span class="na">broadcastUpdatetoPeers</span><span class="p">(</span><span class="n">activenodesforfile</span><span class="p">,</span><span class="w"> </span><span class="n">updates</span><span class="p">);</span>
</span><span id="__span-2-13"><a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>
</span><span id="__span-2-14"><a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Node "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" (Primary): Broadcast initiated."</span><span class="p">);</span>
</span><span id="__span-2-15"><a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em> This method on the primary node receives the <code>updates</code> (new content) and the <code>activenodes</code> list. It saves the list and then calls the <code>broadcastUpdatetoPeers</code> method (likely within its <code>UpdateOperations</code> helper object) to handle the actual distribution of the update.</p>
<p><strong>2. Primary Broadcasts to All Peers (<code>UpdateOperations.broadcastUpdatetoPeers</code>)</strong></p>
<p>This method orchestrates sending the update to <em>all</em> nodes that hold a replica (including the primary itself).</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/middleware/UpdateOperations.java (Simplified method)</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">broadcastUpdatetoPeers</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activenodesforfile</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">updates</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Broadcasting updates to "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">activenodesforfile</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" peers."</span><span class="p">);</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="c1">// Helper to group updates if a node holds multiple replicas (not shown in detail)</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">perNodeUpdates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buildPerNodeUpdates</span><span class="p">(</span><span class="n">activenodesforfile</span><span class="p">,</span><span class="w"> </span><span class="n">updates</span><span class="p">);</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>
</span><span id="__span-3-9"><a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="c1">// Iterate through each node that needs updating</span>
</span><span id="__span-3-10"><a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="n">perNodeUpdates</span><span class="p">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">peerNodeIdStr</span><span class="p">,</span><span class="w"> </span><span class="n">updateMessagesForPeer</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-11"><a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">firstMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">updateMessagesForPeer</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Get info for RMI lookup</span>
</span><span id="__span-3-12"><a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">peerName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstMsg</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">();</span>
</span><span id="__span-3-13"><a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">peerPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstMsg</span><span class="p">.</span><span class="na">getPort</span><span class="p">();</span>
</span><span id="__span-3-14"><a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>
</span><span id="__span-3-15"><a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-16"><a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">            </span><span class="c1">// Is this update for myself (the primary node)?</span>
</span><span id="__span-3-17"><a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">peerNodeIdStr</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">getNodeID</span><span class="p">().</span><span class="na">toString</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-18"><a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Updating local replicas (on Primary)..."</span><span class="p">);</span>
</span><span id="__span-3-19"><a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">                </span><span class="n">updateFileContent</span><span class="p">(</span><span class="n">updateMessagesForPeer</span><span class="p">);</span><span class="w"> </span><span class="c1">// Update myself directly</span>
</span><span id="__span-3-20"><a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-21"><a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">                </span><span class="c1">// It's for a secondary node, contact it via RMI</span>
</span><span id="__span-3-22"><a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Sending update to secondary: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">peerName</span><span class="p">);</span>
</span><span id="__span-3-23"><a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">                </span><span class="n">NodeInterface</span><span class="w"> </span><span class="n">secondaryNodeStub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">getProcessStub</span><span class="p">(</span><span class="n">peerName</span><span class="p">,</span><span class="w"> </span><span class="n">peerPort</span><span class="p">);</span>
</span><span id="__span-3-24"><a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondaryNodeStub</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-25"><a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">                    </span><span class="c1">// Call updateFileContent on the secondary node</span>
</span><span id="__span-3-26"><a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">                    </span><span class="n">secondaryNodeStub</span><span class="p">.</span><span class="na">updateFileContent</span><span class="p">(</span><span class="n">updateMessagesForPeer</span><span class="p">);</span>
</span><span id="__span-3-27"><a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-28"><a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Could not get stub for secondary: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">peerName</span><span class="p">);</span>
</span><span id="__span-3-29"><a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-3-30"><a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-31"><a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-32"><a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Error updating peer "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">peerName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">": "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-3-33"><a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-34"><a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-3-35"><a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Broadcast finished."</span><span class="p">);</span>
</span><span id="__span-3-36"><a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em>
1.  It first organizes the updates per node (using <code>buildPerNodeUpdates</code>, which handles cases where one node might store multiple replicas of the <em>same</em> file, though that's less common here).
2.  It then loops through each unique node (<code>peerNodeIdStr</code>) that needs updating.
3.  <strong>Self-Update:</strong> If the <code>peerNodeIdStr</code> matches the primary node's own ID, it calls <code>updateFileContent</code> locally to update its own copy.
4.  <strong>Remote Update:</strong> If it's a different node (a secondary), it gets an RMI stub for that node (<code>secondaryNodeStub</code>) and remotely calls the <code>updateFileContent</code> method on that secondary node, passing the new content details.</p>
<p><strong>3. Secondary Node Updates Itself (<code>Node.updateFileContent</code>)</strong></p>
<p>When a secondary node receives the <code>updateFileContent</code> call via RMI from the primary, it simply updates its local replica information.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/middleware/Node.java (Simplified method)</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nd">@Override</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateFileContent</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updates</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="c1">// This method receives a list, in case one node holds multiple replicas</span>
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">updates</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">        </span><span class="n">BigInteger</span><span class="w"> </span><span class="n">replicaID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="p">.</span><span class="na">getHashOfFile</span><span class="p">();</span>
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">newContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="p">.</span><span class="na">getBytesOfFile</span><span class="p">();</span>
</span><span id="__span-4-10"><a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">update</span><span class="p">.</span><span class="na">getNameOfFile</span><span class="p">();</span><span class="w"> </span><span class="c1">// For logging</span>
</span><span id="__span-4-11"><a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>
</span><span id="__span-4-12"><a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Node "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" (Secondary): Received update for "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" (Replica ID: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">replicaID</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">")"</span><span class="p">);</span>
</span><span id="__span-4-13"><a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>
</span><span id="__span-4-14"><a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">        </span><span class="c1">// Find the existing metadata Message for this replica in the local map</span>
</span><span id="__span-4-15"><a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">        </span><span class="n">Message</span><span class="w"> </span><span class="n">existingMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filesMetadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">replicaID</span><span class="p">);</span>
</span><span id="__span-4-16"><a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>
</span><span id="__span-4-17"><a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">existingMetadata</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-18"><a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">            </span><span class="c1">// Update the content (in a real system, this might write to disk)</span>
</span><span id="__span-4-19"><a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">            </span><span class="c1">// For simplicity here, we might update the metadata if it held the bytes,</span>
</span><span id="__span-4-20"><a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">            </span><span class="c1">// or assume a separate storage mechanism is updated.</span>
</span><span id="__span-4-21"><a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">            </span><span class="c1">// existingMetadata.setBytesOfFile(newContent); // If bytes were in metadata</span>
</span><span id="__span-4-22"><a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Updating local storage for replica ID: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">replicaID</span><span class="p">);</span>
</span><span id="__span-4-23"><a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">            </span><span class="c1">// updateLocalStorage(replicaID, newContent); // Hypothetical update</span>
</span><span id="__span-4-24"><a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a>
</span><span id="__span-4-25"><a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">            </span><span class="c1">// Maybe update the Lamport clock too (for ordering)</span>
</span><span id="__span-4-26"><a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">            </span><span class="c1">// existingMetadata.setClock(...)</span>
</span><span id="__span-4-27"><a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a>
</span><span id="__span-4-28"><a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Node "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" (Secondary): Update complete for "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">replicaID</span><span class="p">);</span>
</span><span id="__span-4-29"><a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-30"><a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Node "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">": Received update for unknown replica ID: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">replicaID</span><span class="p">);</span>
</span><span id="__span-4-31"><a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-32"><a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-33"><a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em> This method, running on the secondary node, receives the update information. It finds the corresponding replica's metadata in its <code>filesMetadata</code> map using the <code>replicaID</code>. It then performs the actual update (e.g., saving the <code>newContent</code> to disk or updating an in-memory cache) and logs the completion.</p>
<p><strong>Sequence Diagram: Remote Write</strong></p>
<p>Here's how the whole process looks:</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Client as FileManager/User App
    participant Primary as Primary Node
    participant Secondary1 as Secondary Node 1
    participant Secondary2 as Secondary Node 2

    Client -&gt;&gt; Client: Find Primary Node (Check replicaInfo.isPrimaryServer())
    Client -&gt;&gt; Primary: requestRemoteWriteOperation(newContent, replicas) via RMI
    Primary -&gt;&gt; Primary: Store replica list
    Primary -&gt;&gt; Primary: Call broadcastUpdatetoPeers(replicas, newContent)
    Primary -&gt;&gt; Primary: updateFileContent(updateForSelf) [Update local copy]
    Primary -&gt;&gt; Secondary1: updateFileContent(updateForSec1) via RMI
    Secondary1 -&gt;&gt; Secondary1: Update local copy
    Secondary1 --&gt;&gt; Primary: (Acknowledgement - Optional)
    Primary -&gt;&gt; Secondary2: updateFileContent(updateForSec2) via RMI
    Secondary2 -&gt;&gt; Secondary2: Update local copy
    Secondary2 --&gt;&gt; Primary: (Acknowledgement - Optional)
    Primary--&gt;&gt; Client: (Return from initial RMI call)</code></pre>
<p><em>Explanation:</em> The client finds the primary, sends the write request. The primary updates itself locally and then sends <code>updateFileContent</code> calls to all secondaries (Secondary1, Secondary2). Each secondary updates its local copy.</p>
<h2 id="what-about-simultaneous-updates">What About Simultaneous Updates?</h2>
<p>This Remote-Write protocol ensures that if one update completes, all replicas will eventually become consistent. However, it has a limitation: what if two different users try to update the <em>same file</em> at almost the <em>exact same time</em>?</p>
<p>Both users might find the primary node. User A sends their update, and just milliseconds later, User B sends their update. The primary might process A's request, broadcast it, and <em>then</em> process B's request and broadcast that. The final state will reflect User B's changes. But what if the primary processes B first, then A? The final state would reflect User A's changes. This potential inconsistency, depending on the exact timing of requests, is called a <strong>race condition</strong>.</p>
<p>The simple Remote-Write protocol doesn't solve this concurrency problem by itself. We need an additional mechanism to ensure that only one update process can happen at a time for a specific file. This concept is called <strong>mutual exclusion</strong>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this chapter, we tackled the problem of keeping multiple file copies (replicas) consistent after updates. We learned about the <strong>Remote-Write Protocol</strong>, a primary-copy strategy where:</p>
<ol>
<li>One replica is designated <strong>Primary</strong>.</li>
<li>All updates are sent <em>only</em> to the Primary.</li>
<li>The Primary updates itself and then <strong>broadcasts</strong> the update to all <strong>Secondary</strong> replicas.</li>
</ol>
<p>We saw how the <code>FileManager</code> finds the primary using the <code>isPrimaryServer</code> flag in the <a href="../06_message_/">Message</a> objects and how the update propagates through RMI calls like <code>requestRemoteWriteOperation</code> and <code>updateFileContent</code>. This protocol helps ensure that replicas don't permanently diverge after updates.</p>
<p>However, we also touched upon the limitation of handling simultaneous update requests. To address this and ensure only one client can modify a file at a time, we need mechanisms for locking. That's exactly what we'll explore in the next chapter on <a href="../08_distributed_mutual_exclusion_/">Distributed Mutual Exclusion</a>.</p>
<hr/>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
</body>
</html>