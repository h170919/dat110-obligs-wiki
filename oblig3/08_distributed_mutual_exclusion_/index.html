
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../07_consistency__remote_write_protocol__/" rel="prev"/>
<link href="../oblig3_index/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.12" name="generator"/>
<title>Chapter 8: Distributed Mutual Exclusion - dat110 notes</title>
<link href="../../assets/stylesheets/main.2afb09e1.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#chapter-8-distributed-mutual-exclusion">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="dat110 notes" class="md-header__button md-logo" data-md-component="logo" href="../.." title="dat110 notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            dat110 notes
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Chapter 8: Distributed Mutual Exclusion
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="dat110 notes" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="dat110 notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    dat110 notes
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Oblig1
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Oblig1
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/01_rpc_client_stub_/">
<span class="md-ellipsis">
    Chapter 1: RPC Client Stub
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/02_rpc_server_implementation__skeleton__/">
<span class="md-ellipsis">
    Chapter 2: RPC Server Implementation (Skeleton)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/03_rpc_client_/">
<span class="md-ellipsis">
    Chapter 3: RPC Client
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/04_rpc_server_/">
<span class="md-ellipsis">
    Chapter 4: RPC Server
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/05_rpc_data_marshalling_unmarshalling_/">
<span class="md-ellipsis">
    Chapter 5: RPC Data Marshalling/Unmarshalling
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/06_messaging_connection_/">
<span class="md-ellipsis">
    Chapter 6: Messaging Connection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/07_message_framing_protocol_/">
<span class="md-ellipsis">
    Chapter 7: Message Framing Protocol
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig1/oblig1_index/">
<span class="md-ellipsis">
    Project 1 Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Oblig2
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Oblig2
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/00_index/">
<span class="md-ellipsis">
    Tutorial: dat110-oblig2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/01_client_/">
<span class="md-ellipsis">
    Chapter 1: Client
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/02_broker_/">
<span class="md-ellipsis">
    Chapter 2: Broker
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/03_message_/">
<span class="md-ellipsis">
    Chapter 3: Message
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/04_messagetype_/">
<span class="md-ellipsis">
    Chapter 4: MessageType
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/05_messageutils_/">
<span class="md-ellipsis">
    Chapter 5: MessageUtils
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/06_connection_/">
<span class="md-ellipsis">
    Chapter 6: Connection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/07_dispatcher_/">
<span class="md-ellipsis">
    Chapter 7: Dispatcher
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/08_storage_/">
<span class="md-ellipsis">
    Chapter 8: Storage
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/09_clientsession_/">
<span class="md-ellipsis">
    Chapter 9: ClientSession
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../oblig2/10_stopable_/">
<span class="md-ellipsis">
    Chapter 10: Stopable
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Oblig3
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Oblig3
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../01_file_management___replication_/">
<span class="md-ellipsis">
    Chapter 1: File Management &amp; Replication
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../02_node__peer__/">
<span class="md-ellipsis">
    Chapter 2: Node (Peer)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../03_remote_communication__rmi__/">
<span class="md-ellipsis">
    Chapter 3: Remote Communication (RMI)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../04_hashing___id_space_/">
<span class="md-ellipsis">
    Chapter 4: Hashing &amp; ID Space
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../05_chord_protocol__ring__lookup__stabilization__/">
<span class="md-ellipsis">
    Chapter 5: Chord Protocol (Ring, Lookup, Stabilization)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../06_message_/">
<span class="md-ellipsis">
    Chapter 6: Message
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../07_consistency__remote_write_protocol__/">
<span class="md-ellipsis">
    Chapter 7: Consistency (Remote-Write Protocol)
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Chapter 8: Distributed Mutual Exclusion
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Chapter 8: Distributed Mutual Exclusion
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-problem-colliding-updates">
<span class="md-ellipsis">
      The Problem: Colliding Updates
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-concepts-the-traffic-light-system">
<span class="md-ellipsis">
      Key Concepts: The Traffic Light System
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#using-mutual-exclusion-for-file-updates">
<span class="md-ellipsis">
      Using Mutual Exclusion for File Updates
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#internal-implementation-the-voting-protocol">
<span class="md-ellipsis">
      Internal Implementation: The Voting Protocol
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../oblig3_index/">
<span class="md-ellipsis">
    Project 3 Overview
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-problem-colliding-updates">
<span class="md-ellipsis">
      The Problem: Colliding Updates
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#key-concepts-the-traffic-light-system">
<span class="md-ellipsis">
      Key Concepts: The Traffic Light System
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#using-mutual-exclusion-for-file-updates">
<span class="md-ellipsis">
      Using Mutual Exclusion for File Updates
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#internal-implementation-the-voting-protocol">
<span class="md-ellipsis">
      Internal Implementation: The Voting Protocol
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="chapter-8-distributed-mutual-exclusion">Chapter 8: Distributed Mutual Exclusion</h1>
<p>Welcome to the final chapter! In the <a href="07_consistency__remote_write_protocol_.md">previous chapter</a>, we learned how the Remote-Write protocol helps keep file replicas consistent by funneling all updates through a single <strong>Primary</strong> node. However, we also noted a potential problem: what if two different users try to update the <em>same file</em> at almost the <em>exact same time</em>? Both might send their requests to the Primary node nearly simultaneously. Without a coordination mechanism, the final state of the file might depend unpredictably on which request gets processed first, leading to a "race condition".</p>
<p>This chapter introduces <strong>Distributed Mutual Exclusion</strong>, a protocol designed to solve exactly this problem. It ensures that even in a system with no central controller, only one <a href="../02_node__peer__/">Node (Peer)</a> can modify a specific file replica (or enter the "critical section" related to it) at any given time.</p>
<p><strong>What You'll Learn:</strong></p>
<ul>
<li>Why we need to control access when multiple nodes want to update the same file concurrently.</li>
<li>What a "critical section" is.</li>
<li>How nodes can coordinate using Lamport clocks and voting to achieve mutual exclusion.</li>
<li>How a node requests and obtains permission (a "lock") before modifying a file.</li>
</ul>
<h2 id="the-problem-colliding-updates">The Problem: Colliding Updates</h2>
<p>Imagine our shared file is like a physical file cabinet in an office building. Several different offices (<a href="../02_node__peer__/">Nodes (Peers)</a>) might realize they need to update the same file in the cabinet at the same time. If they all rush to the cabinet simultaneously and try to write their changes, the file could end up garbled or reflecting only the changes from the last person who wrote, potentially overwriting important information from others.</p>
<p>We need a system to ensure only one office gets to open the cabinet and modify the file at a time, while others wait their turn politely.</p>
<h2 id="key-concepts-the-traffic-light-system">Key Concepts: The Traffic Light System</h2>
<p>Think of Distributed Mutual Exclusion as a sophisticated traffic light system for accessing the shared file cabinet (our file replica).</p>
<ol>
<li><strong>Critical Section:</strong> This is the action of accessing and modifying the shared resource – opening the cabinet and writing to the file. Our goal is to allow only one "car" (node's update request) into this section at a time.</li>
<li><strong>Mutual Exclusion:</strong> This is the "one car at a time" rule enforced by the traffic light.</li>
<li><strong>Distributed Coordination:</strong> Unlike a real traffic intersection with one controller, our "traffic lights" are controlled by agreement among <em>all</em> the offices (nodes) that hold a copy of the file. There's no single boss.</li>
<li><strong>Logical Clocks (Lamport Clocks):</strong> How do we decide who goes first if multiple offices request access at roughly the same time? We use Lamport Clocks, which act like sequential ticket numbers. Each request gets a "timestamp" (a number from the clock). Lower numbers generally get priority. If two requests have the exact same timestamp, we use the unique <a href="../04_hashing___id_space_/">Node ID</a> (like the office room number) to break the tie consistently (e.g., the lower ID goes first). We saw this clock in the <a href="../06_message_/">Message</a> chapter.</li>
<li><strong>Voting/Permission:</strong> Before an office can approach the file cabinet (enter the critical section), it must send a request message to <em>all</em> other offices holding a copy of that file. It must then wait until it receives an "OK" (permission message, or vote) back from <em>every single one</em> of them. This ensures everyone agrees it's this office's turn.</li>
</ol>
<h2 id="using-mutual-exclusion-for-file-updates">Using Mutual Exclusion for File Updates</h2>
<p>How does a user, perhaps through the application's GUI, trigger an update that uses this mutual exclusion mechanism? The process builds upon what we learned in the <a href="07_consistency__remote_write_protocol_.md">Consistency (Remote-Write Protocol)</a> chapter.</p>
<ol>
<li><strong>User Initiates Update:</strong> The user modifies the file content in the application (like in the <code>FileContentUpdate</code> GUI).</li>
<li><strong>Identify Primary &amp; Peers:</strong> The application (e.g., using <code>FileManager</code>) finds the primary node and the set of all active nodes (<code>activepeers</code>) holding replicas for the file, just like in Chapter 7.</li>
<li><strong>Request Lock (Mutex):</strong> Instead of directly calling the update broadcast, the application now calls a special method on the <em>primary</em> node: <code>requestMutexWriteOperation</code>. This method initiates the mutual exclusion protocol (the voting process).</li>
<li><strong>Wait for Permission:</strong> The primary node executes the protocol. It requests permission from all <code>activepeers</code> (including itself) and waits for replies.</li>
<li><strong>If Granted:</strong> Once the primary node receives permission from everyone, it knows it has exclusive access (the "lock").</li>
<li><strong>Perform Update:</strong> Only now does the primary node proceed with the update broadcast (<code>broadcastUpdatetoPeers</code>) as described in Chapter 7.</li>
<li><strong>Release Lock:</strong> After the update broadcast is complete (or has been reliably initiated), the primary node releases the lock, sending messages to all peers informing them that the critical section is now free. This allows the next waiting node (if any) to proceed.</li>
</ol>
<p><strong>Example Code Triggering the Process (GUI):</strong></p>
<p>Let's look at the <code>FileContentUpdate.java</code> code snippet, which shows how the update button might trigger this. <code>selectedpeer</code> here is assumed to be the <em>primary</em> node for the file being updated. <code>selectedpeerdata</code> is a <a href="../06_message_/">Message</a> object containing metadata about the file on the primary.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/gui/FileContentUpdate.java (Simplified btnUpdateContent)</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">btnUpdateContent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">newcontent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">txtArea</span><span class="p">.</span><span class="na">getText</span><span class="p">();</span><span class="w"> </span><span class="c1">// Get the new text from the GUI</span>
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">        </span><span class="c1">// Get the list of all nodes holding replicas for this file</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activepeers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filemanager</span><span class="p">.</span><span class="na">getActiveNodesforFile</span><span class="p">();</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activepeers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">            </span><span class="n">activepeers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filemanager</span><span class="p">.</span><span class="na">requestActiveNodesForFile</span><span class="p">(</span><span class="n">selectedpeerdata</span><span class="p">.</span><span class="na">getNameOfFile</span><span class="p">());</span>
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activepeers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">activepeers</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">            </span><span class="n">JOptionPane</span><span class="p">.</span><span class="na">showMessageDialog</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">"Cannot find replica locations!"</span><span class="p">,</span><span class="w"> </span><span class="s">"Error"</span><span class="p">,</span><span class="w"> </span><span class="n">JOptionPane</span><span class="p">.</span><span class="na">ERROR_MESSAGE</span><span class="p">);</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="c1">// --- Mutual Exclusion Start ---</span>
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Requesting mutex lock from primary: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">selectedpeer</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">());</span>
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">        </span><span class="c1">// selectedpeer is the primary node's RMI stub</span>
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">        </span><span class="c1">// selectedpeerdata contains info like clock, node ID for the request message</span>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">lockGranted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selectedpeer</span><span class="p">.</span><span class="na">requestMutexWriteOperation</span><span class="p">(</span>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">                </span><span class="n">selectedpeerdata</span><span class="p">,</span><span class="w">          </span><span class="c1">// Message with request info (clock, ID)</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">                </span><span class="n">newcontent</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(),</span><span class="w">     </span><span class="c1">// The actual updates to be applied LATER</span>
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">                </span><span class="n">activepeers</span><span class="w">                </span><span class="c1">// Set of all nodes involved in voting</span>
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">        </span><span class="p">);</span>
</span><span id="__span-0-26"><a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">        </span><span class="c1">// --- Mutual Exclusion End (blocks until granted or failed) ---</span>
</span><span id="__span-0-27"><a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>
</span><span id="__span-0-28"><a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">        </span><span class="n">JOptionPane</span><span class="p">.</span><span class="na">showMessageDialog</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">"Access granted? "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lockGranted</span><span class="p">,</span><span class="w"> </span><span class="s">"Message"</span><span class="p">,</span><span class="w"> </span><span class="n">JOptionPane</span><span class="p">.</span><span class="na">INFORMATION_MESSAGE</span><span class="p">);</span>
</span><span id="__span-0-29"><a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>
</span><span id="__span-0-30"><a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lockGranted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-31"><a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Lock acquired! Update should have been broadcast by primary."</span><span class="p">);</span>
</span><span id="__span-0-32"><a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">            </span><span class="c1">// NOTE: The actual broadcastUpdatetoPeers is called *inside* the primary node</span>
</span><span id="__span-0-33"><a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">            </span><span class="c1">//       after it successfully acquires the lock within requestMutexWriteOperation.</span>
</span><span id="__span-0-34"><a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">            </span><span class="c1">//       The primary also needs to release the lock eventually.</span>
</span><span id="__span-0-35"><a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>
</span><span id="__span-0-36"><a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">            </span><span class="c1">// --- Release Lock (implicitly handled by primary or needs explicit call?) ---</span>
</span><span id="__span-0-37"><a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">            </span><span class="c1">// The provided code seems to have the primary release locks *before* requesting?</span>
</span><span id="__span-0-38"><a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">            </span><span class="c1">// Let's assume the primary releases *after* the update.</span>
</span><span id="__span-0-39"><a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">            </span><span class="c1">// It might call multicastReleaseLocks internally or the client might trigger it.</span>
</span><span id="__span-0-40"><a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">            </span><span class="c1">// selectedpeer.multicastReleaseLocks(activepeers); // Maybe called by primary internally</span>
</span><span id="__span-0-41"><a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-42"><a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">             </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Failed to acquire lock."</span><span class="p">);</span>
</span><span id="__span-0-43"><a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-44"><a href="#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a>
</span><span id="__span-0-45"><a href="#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-46"><a href="#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">        </span><span class="n">JOptionPane</span><span class="p">.</span><span class="na">showMessageDialog</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">"RMI Error: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(),</span><span class="w"> </span><span class="s">"Error"</span><span class="p">,</span><span class="w"> </span><span class="n">JOptionPane</span><span class="p">.</span><span class="na">ERROR_MESSAGE</span><span class="p">);</span>
</span><span id="__span-0-47"><a href="#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
</span><span id="__span-0-48"><a href="#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-49"><a href="#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em>
1.  It gets the updated text and the list of all nodes (<code>activepeers</code>) holding replicas.
2.  It calls <code>selectedpeer.requestMutexWriteOperation(...)</code> via <a href="03_remote_communication__rmi_.md">Remote Communication (RMI)</a> on the primary node.
3.  It passes:
    *   <code>selectedpeerdata</code>: A <a href="../06_message_/">Message</a> object that the <code>MutualExclusion</code> logic will use to store the Lamport clock time and ID of this request.
    *   <code>newcontent.getBytes()</code>: The actual file changes. The primary node will hold onto this and only broadcast it <em>after</em> getting the lock.
    *   <code>activepeers</code>: The list of all nodes who need to vote.
4.  This call <strong>blocks</strong> (waits) until the primary node successfully gets permission from all peers (returns <code>true</code>) or fails/times out (returns <code>false</code>).
5.  If <code>lockGranted</code> is <code>true</code>, the user knows the primary node has acquired the lock and has initiated the update broadcast (from Chapter 7) within its locked critical section.</p>
<h2 id="internal-implementation-the-voting-protocol">Internal Implementation: The Voting Protocol</h2>
<p>Let's peek inside the <code>MutualExclusion.java</code> class on a <a href="../02_node__peer__/">Node (Peer)</a> to see how this voting happens.</p>
<p><strong>Scenario:</strong> Node P (Primary) receives <code>requestMutexWriteOperation</code> and needs to get permission from Node A and Node B (and itself).</p>
<p><strong>Step 1: Initiate Request (<code>doMutexRequest</code>)</strong></p>
<p>When <code>requestMutexWriteOperation</code> is called on Node P, it delegates to <code>MutualExclusion.doMutexRequest</code>.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/middleware/MutualExclusion.java (Simplified doMutexRequest)</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">doMutexRequest</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">updates</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" wants to access CS"</span><span class="p">);</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="c1">// Clear previous acknowledgements and queued requests</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">queueack</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="n">mutexqueue</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="c1">// 1. Increment local Lamport clock</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="n">clock</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="c1">// 2. Set clock on the outgoing request message</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="n">message</span><span class="p">.</span><span class="na">setClock</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="na">getClock</span><span class="p">());</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="n">node</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">setClock</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="na">getClock</span><span class="p">());</span><span class="w"> </span><span class="c1">// Update node's own message clock too</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="c1">// 3. Mark intention to enter CS</span>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="n">WANTS_TO_ENTER_CS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="c1">// 4. Get unique list of peers to send requests to</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activenodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">removeDuplicatePeersBeforeVoting</span><span class="p">();</span>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="c1">// 5. Send request to all peers (including self)</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="n">multicastMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">activenodes</span><span class="p">);</span>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="c1">// --- Wait for Replies ---</span>
</span><span id="__span-1-25"><a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="c1">// (Simplified: loop or wait mechanism needed here to check areAllMessagesReturned)</span>
</span><span id="__span-1-26"><a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
</span><span id="__span-1-27"><a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">areAllMessagesReturned</span><span class="p">(</span><span class="n">activenodes</span><span class="p">.</span><span class="na">size</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-28"><a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">        </span><span class="c1">// Wait for acknowledgements to arrive via onMutexAcknowledgementReceived</span>
</span><span id="__span-1-29"><a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">        </span><span class="c1">// Add a timeout to prevent infinite waiting</span>
</span><span id="__span-1-30"><a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 5 sec timeout</span>
</span><span id="__span-1-31"><a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">             </span><span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" timed out waiting for ACKs."</span><span class="p">);</span>
</span><span id="__span-1-32"><a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">             </span><span class="n">WANTS_TO_ENTER_CS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-1-33"><a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Failed to get lock</span>
</span><span id="__span-1-34"><a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-35"><a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// Pause briefly</span>
</span><span id="__span-1-36"><a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-37"><a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">    </span><span class="c1">// --- All Replies Received ---</span>
</span><span id="__span-1-38"><a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>
</span><span id="__span-1-39"><a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">    </span><span class="c1">// 6. Acquire the lock (enter critical section)</span>
</span><span id="__span-1-40"><a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">    </span><span class="n">acquireLock</span><span class="p">();</span>
</span><span id="__span-1-41"><a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" LOCK ACQUIRED"</span><span class="p">);</span>
</span><span id="__span-1-42"><a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>
</span><span id="__span-1-43"><a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">    </span><span class="c1">// --- Critical Section Start ---</span>
</span><span id="__span-1-44"><a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">    </span><span class="n">node</span><span class="p">.</span><span class="na">broadcastUpdatetoPeers</span><span class="p">(</span><span class="n">updates</span><span class="p">);</span><span class="w"> </span><span class="c1">// Perform the actual update (from Chapter 7)</span>
</span><span id="__span-1-45"><a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">    </span><span class="c1">// --- Critical Section End ---</span>
</span><span id="__span-1-46"><a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a>
</span><span id="__span-1-47"><a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">    </span><span class="c1">// 7. Release the lock and notify queued processes</span>
</span><span id="__span-1-48"><a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">    </span><span class="n">releaseLocks</span><span class="p">();</span><span class="w"> </span><span class="c1">// Mark CS as free</span>
</span><span id="__span-1-49"><a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">    </span><span class="n">multicastReleaseLocks</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">getActiveNodesforFile</span><span class="p">());</span><span class="w"> </span><span class="c1">// Tell peers lock is free</span>
</span><span id="__span-1-50"><a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">    </span><span class="n">sendQueuedAcknowledgements</span><span class="p">();</span><span class="w"> </span><span class="c1">// Tell waiting nodes they can try now</span>
</span><span id="__span-1-51"><a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>
</span><span id="__span-1-52"><a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">    </span><span class="n">mutexqueue</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
</span><span id="__span-1-53"><a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// Success!</span>
</span><span id="__span-1-54"><a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="p">}</span>
</span><span id="__span-1-55"><a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>
</span><span id="__span-1-56"><a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="c1">// Helper to send request messages</span>
</span><span id="__span-1-57"><a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">multicastMessage</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activenodes</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-58"><a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"Multicasting mutex request to "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">activenodes</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" peers."</span><span class="p">);</span>
</span><span id="__span-1-59"><a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">activenodes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-60"><a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="w">        </span><span class="n">NodeInterface</span><span class="w"> </span><span class="n">stub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">getProcessStub</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getPort</span><span class="p">());</span>
</span><span id="__span-1-61"><a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stub</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-62"><a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">            </span><span class="c1">// Make RMI call to each peer</span>
</span><span id="__span-1-63"><a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="w">            </span><span class="n">stub</span><span class="p">.</span><span class="na">onMutexRequestReceived</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span id="__span-1-64"><a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="c1">// else handle error: node might be down</span>
</span><span id="__span-1-65"><a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-66"><a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em>
1.  Increments its Lamport clock (<code>clock.increment()</code>) to get a unique timestamp for this request.
2.  Sets this timestamp on the outgoing <code>message</code>.
3.  Sets <code>WANTS_TO_ENTER_CS = true</code>.
4.  Gets the list of unique peers involved.
5.  Calls <code>multicastMessage</code> to send an <code>onMutexRequestReceived</code> RMI call to every peer (Node A, Node B, and itself).
6.  It then enters a waiting loop (<code>while (!areAllMessagesReturned(...)</code>) until it receives acknowledgments (<code>queueack</code>) from all peers. (This internal waiting logic is crucial).
7.  Once all ACKs are received, it calls <code>acquireLock()</code> (sets <code>CS_BUSY = true</code>), performs the <code>broadcastUpdatetoPeers</code> from Chapter 7, and then releases the lock using <code>releaseLocks()</code> and <code>multicastReleaseLocks</code>.</p>
<p><strong>Step 2: Handling Received Requests (<code>onMutexRequestReceived</code>, <code>doDecisionAlgorithm</code>)</strong></p>
<p>Now, what happens when Node A receives the <code>onMutexRequestReceived(message)</code> call from Node P?</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/middleware/MutualExclusion.java (Simplified Request Handling)</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMutexRequestReceived</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="c1">// Increment local clock because an event occurred</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="n">clock</span><span class="p">.</span><span class="na">increment</span><span class="p">();</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="n">clock</span><span class="p">.</span><span class="na">adjustClock</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="na">getClock</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getClock</span><span class="p">()));</span><span class="w"> </span><span class="c1">// Adjust clock based on message</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="c1">// Decide whether to grant permission immediately or queue the request</span>
</span><span id="__span-2-9"><a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">caseid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-2-10"><a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CS_BUSY</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">WANTS_TO_ENTER_CS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Case 0: I'm idle</span>
</span><span id="__span-2-11"><a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">        </span><span class="n">caseid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-12"><a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CS_BUSY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                </span><span class="c1">// Case 1: I'm in the CS</span>
</span><span id="__span-2-13"><a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">        </span><span class="n">caseid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-2-14"><a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">                             </span><span class="c1">// Case 2: I also want to enter CS</span>
</span><span id="__span-2-15"><a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="n">caseid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-2-16"><a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-17"><a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>
</span><span id="__span-2-18"><a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="n">doDecisionAlgorithm</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">mutexqueue</span><span class="p">,</span><span class="w"> </span><span class="n">caseid</span><span class="p">);</span>
</span><span id="__span-2-19"><a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="p">}</span>
</span><span id="__span-2-20"><a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>
</span><span id="__span-2-21"><a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doDecisionAlgorithm</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-22"><a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">requesterName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">();</span>
</span><span id="__span-2-23"><a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">requesterPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPort</span><span class="p">();</span>
</span><span id="__span-2-24"><a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>
</span><span id="__span-2-25"><a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-26"><a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="c1">// Idle: Grant permission immediately</span>
</span><span id="__span-2-27"><a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">            </span><span class="n">NodeInterface</span><span class="w"> </span><span class="n">requesterStub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">getProcessStub</span><span class="p">(</span><span class="n">requesterName</span><span class="p">,</span><span class="w"> </span><span class="n">requesterPort</span><span class="p">);</span>
</span><span id="__span-2-28"><a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requesterStub</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-29"><a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">                 </span><span class="c1">// Send ACK back to the requester (Node P)</span>
</span><span id="__span-2-30"><a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">                </span><span class="n">requesterStub</span><span class="p">.</span><span class="na">onMutexAcknowledgementReceived</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-2-31"><a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-2-32"><a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-33"><a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="c1">// Busy: Queue the request, don't reply yet</span>
</span><span id="__span-2-34"><a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" is BUSY, queueing request from "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requesterName</span><span class="p">);</span>
</span><span id="__span-2-35"><a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">            </span><span class="n">queue</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span id="__span-2-36"><a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-37"><a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="c1">// Also Wants: Compare timestamps (and NodeIDs if timestamps equal)</span>
</span><span id="__span-2-38"><a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">requesterClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getClock</span><span class="p">();</span>
</span><span id="__span-2-39"><a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">myClock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getClock</span><span class="p">();</span>
</span><span id="__span-2-40"><a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="w">            </span><span class="n">BigInteger</span><span class="w"> </span><span class="n">requesterID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getNodeID</span><span class="p">();</span>
</span><span id="__span-2-41"><a href="#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="w">            </span><span class="n">BigInteger</span><span class="w"> </span><span class="n">myID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="na">getNodeID</span><span class="p">();</span>
</span><span id="__span-2-42"><a href="#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a>
</span><span id="__span-2-43"><a href="#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a><span class="w">            </span><span class="c1">// Grant permission if requester has lower clock, or same clock and lower ID</span>
</span><span id="__span-2-44"><a href="#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requesterClock</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">myClock</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">requesterClock</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">myClock</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">requesterID</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">myID</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-45"><a href="#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="w">                 </span><span class="n">NodeInterface</span><span class="w"> </span><span class="n">stub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">getProcessStub</span><span class="p">(</span><span class="n">requesterName</span><span class="p">,</span><span class="w"> </span><span class="n">requesterPort</span><span class="p">);</span>
</span><span id="__span-2-46"><a href="#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="w">                 </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stub</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-47"><a href="#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a><span class="w">                     </span><span class="c1">// Send ACK back</span>
</span><span id="__span-2-48"><a href="#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a><span class="w">                     </span><span class="n">stub</span><span class="p">.</span><span class="na">onMutexAcknowledgementReceived</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-2-49"><a href="#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a><span class="w">                 </span><span class="p">}</span>
</span><span id="__span-2-50"><a href="#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-51"><a href="#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a><span class="w">                 </span><span class="c1">// Requester has higher priority or equal, queue their request</span>
</span><span id="__span-2-52"><a href="#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a><span class="w">                 </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" wants lock too, queueing request from "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">requesterName</span><span class="p">);</span>
</span><span id="__span-2-53"><a href="#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a><span class="w">                 </span><span class="n">queue</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span id="__span-2-54"><a href="#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-2-55"><a href="#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-56"><a href="#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-57"><a href="#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em>
1.  Node A receives the request, increments its clock.
2.  It checks its own state (<code>CS_BUSY</code>, <code>WANTS_TO_ENTER_CS</code>).
3.  <code>doDecisionAlgorithm</code> decides:
    *   <strong>Case 0 (Idle):</strong> Node A isn't using the resource and doesn't want it. It immediately sends an "OK" (<code>onMutexAcknowledgementReceived</code>) back to Node P via RMI.
    *   <strong>Case 1 (Busy):</strong> Node A is currently <em>in</em> the critical section. It cannot grant permission now, so it adds Node P's request to its <code>mutexqueue</code> and does <em>not</em> reply yet.
    *   <strong>Case 2 (Wants):</strong> Node A also wants to enter the critical section. It compares its own request's Lamport timestamp (<code>myClock</code>) with Node P's request timestamp (<code>requesterClock</code>).
        *   If Node P has a lower timestamp (or the same timestamp but a lower Node ID), Node A grants permission (sends ACK back). Node P has priority.
        *   Otherwise, Node A has priority. It queues Node P's request in <code>mutexqueue</code> and does <em>not</em> reply yet.</p>
<p><strong>Step 3: Receiving Acknowledgements (<code>onMutexAcknowledgementReceived</code>)</strong></p>
<p>When Node P receives an "OK" message back from Node A (or B, or itself), the <code>onMutexAcknowledgementReceived</code> method is called on Node P.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/middleware/MutualExclusion.java (Simplified ACK Handling)</span>
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMutexAcknowledgementReceived</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" received ACK from "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">());</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="c1">// Add the ACK to the list</span>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="n">queueack</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="c1">// The waiting loop in doMutexRequest will check if queueack.size() is now sufficient</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="p">}</span>
</span><span id="__span-3-9"><a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="c1">// Helper called by doMutexRequest</span>
</span><span id="__span-3-11"><a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">areAllMessagesReturned</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">numvoters</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-12"><a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="c1">//logger.info(node.getNodeName()+": Size of queueack = "+queueack.size()+", Voters = "+numvoters);</span>
</span><span id="__span-3-13"><a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">queueack</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numvoters</span><span class="p">;</span>
</span><span id="__span-3-14"><a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em> This method simply adds the received acknowledgment <a href="../06_message_/">Message</a> to the <code>queueack</code> list. The loop inside <code>doMutexRequest</code> continuously checks <code>areAllMessagesReturned</code> to see if enough ACKs have arrived.</p>
<p><strong>Step 4: Releasing the Lock (<code>releaseLocks</code>, <code>multicastReleaseLocks</code>)</strong></p>
<p>After Node P finishes its update broadcast inside the critical section, it calls <code>releaseLocks</code> and <code>multicastReleaseLocks</code>.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// File: src/main/java/no/hvl/dat110/middleware/MutualExclusion.java (Simplified Release)</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">releaseLocks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="n">WANTS_TO_ENTER_CS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">CS_BUSY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-4-6"><a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">nodename</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" LOCK RELEASED"</span><span class="p">);</span>
</span><span id="__span-4-7"><a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="p">}</span>
</span><span id="__span-4-8"><a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>
</span><span id="__span-4-9"><a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1">// This is called by the node *leaving* the CS</span>
</span><span id="__span-4-10"><a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">multicastReleaseLocks</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">activenodes</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-11"><a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"Multicasting release message to "</span><span class="o">+</span><span class="w"> </span><span class="n">activenodes</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">+</span><span class="s">" peers."</span><span class="p">);</span>
</span><span id="__span-4-12"><a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="c1">// Remove self from the list, no need to tell self</span>
</span><span id="__span-4-13"><a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">others</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">activenodes</span><span class="p">);</span>
</span><span id="__span-4-14"><a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="n">others</span><span class="p">.</span><span class="na">removeIf</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getNodeID</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">getNodeID</span><span class="p">()));</span>
</span><span id="__span-4-15"><a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>
</span><span id="__span-4-16"><a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">others</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-17"><a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">        </span><span class="n">NodeInterface</span><span class="w"> </span><span class="n">stub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">getProcessStub</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getPort</span><span class="p">());</span>
</span><span id="__span-4-18"><a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stub</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-19"><a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-20"><a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">                </span><span class="c1">// Tell the other peer to call its local releaseLocks method</span>
</span><span id="__span-4-21"><a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">                </span><span class="n">stub</span><span class="p">.</span><span class="na">releaseLocks</span><span class="p">();</span><span class="w"> </span><span class="c1">// This remote call triggers the method below on the peer</span>
</span><span id="__span-4-22"><a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RemoteException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-23"><a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">                </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">"Failed releasing lock on peer "</span><span class="o">+</span><span class="n">m</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">()</span><span class="o">+</span><span class="s">": "</span><span class="o">+</span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-4-24"><a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-4-25"><a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-26"><a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-27"><a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">    </span><span class="c1">// Also send acknowledgements to any processes waiting in our queue</span>
</span><span id="__span-4-28"><a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">    </span><span class="n">sendQueuedAcknowledgements</span><span class="p">();</span>
</span><span id="__span-4-29"><a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="p">}</span>
</span><span id="__span-4-30"><a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a>
</span><span id="__span-4-31"><a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="c1">// This method is called *remotely* on a peer when the lock holder releases</span>
</span><span id="__span-4-32"><a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="nd">@Override</span>
</span><span id="__span-4-33"><a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">releaseLocks</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-34"><a href="#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">    </span><span class="c1">// Mark lock as free on this peer</span>
</span><span id="__span-4-35"><a href="#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">    </span><span class="n">releaseLocks</span><span class="p">();</span>
</span><span id="__span-4-36"><a href="#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">    </span><span class="c1">// Check if we had queued requests, and send ACKs to them now</span>
</span><span id="__span-4-37"><a href="#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">    </span><span class="n">sendQueuedAcknowledgements</span><span class="p">();</span>
</span><span id="__span-4-38"><a href="#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="p">}</span>
</span><span id="__span-4-39"><a href="#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a>
</span><span id="__span-4-40"><a href="#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="c1">// Helper to process the queue of waiting requests after releasing the lock</span>
</span><span id="__span-4-41"><a href="#__codelineno-4-41" id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="kd">private</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendQueuedAcknowledgements</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">RemoteException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-42"><a href="#__codelineno-4-42" id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span><span class="w"> </span><span class="n">processed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-4-43"><a href="#__codelineno-4-43" id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">waiting_msg</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">mutexqueue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-44"><a href="#__codelineno-4-44" id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">        </span><span class="n">NodeInterface</span><span class="w"> </span><span class="n">stub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">getProcessStub</span><span class="p">(</span><span class="n">waiting_msg</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">(),</span><span class="w"> </span><span class="n">waiting_msg</span><span class="p">.</span><span class="na">getPort</span><span class="p">());</span>
</span><span id="__span-4-45"><a href="#__codelineno-4-45" id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stub</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-46"><a href="#__codelineno-4-46" id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="w">             </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"Sending delayed ACK to queued node "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">waiting_msg</span><span class="p">.</span><span class="na">getNodeName</span><span class="p">());</span>
</span><span id="__span-4-47"><a href="#__codelineno-4-47" id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="w">             </span><span class="n">stub</span><span class="p">.</span><span class="na">onMutexAcknowledgementReceived</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</span><span id="__span-4-48"><a href="#__codelineno-4-48" id="__codelineno-4-48" name="__codelineno-4-48"></a><span class="w">             </span><span class="n">processed</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">waiting_msg</span><span class="p">);</span>
</span><span id="__span-4-49"><a href="#__codelineno-4-49" id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="w">         </span><span class="p">}</span>
</span><span id="__span-4-50"><a href="#__codelineno-4-50" id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-51"><a href="#__codelineno-4-51" id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="w">    </span><span class="n">mutexqueue</span><span class="p">.</span><span class="na">removeAll</span><span class="p">(</span><span class="n">processed</span><span class="p">);</span><span class="w"> </span><span class="c1">// Remove processed requests from queue</span>
</span><span id="__span-4-52"><a href="#__codelineno-4-52" id="__codelineno-4-52" name="__codelineno-4-52"></a><span class="p">}</span>
</span></code></pre></div>
<p><em>Explanation:</em>
1.  <code>releaseLocks()</code>: Resets the <code>WANTS_TO_ENTER_CS</code> and <code>CS_BUSY</code> flags locally.
2.  <code>multicastReleaseLocks()</code>: Sends a <code>releaseLocks()</code> RMI call to all <em>other</em> peers involved. This tells them the critical section is now free.
3.  <code>sendQueuedAcknowledgements()</code>: Critically, after releasing the lock, the node checks its <code>mutexqueue</code>. For any requests it had previously deferred (because it was busy or had priority), it now sends the "OK" acknowledgment message back to those waiting nodes. This allows the next node in line (by timestamp/ID priority) to potentially acquire the lock.</p>
<p><strong>Sequence Diagram: Mutex Request</strong></p>
<p>Here's a simplified flow for Node P requesting access from A and B:</p>
<pre class="mermaid"><code>sequenceDiagram
    participant P as "Requesting Node (Primary)"
    participant A as "Peer Node A"
    participant B as "Peer Node B"

    P-&gt;&gt;P: User triggers update \-&gt; doMutexRequest()
    P-&gt;&gt;P: clock++, WANTS_TO_ENTER_CS=true
    P-&gt;&gt;A: onMutexRequestReceived(Req_P) via RMI
    P-&gt;&gt;B: onMutexRequestReceived(Req_P) via RMI
    P-&gt;&gt;P: onMutexRequestReceived(Req_P) [Self Request]

    Note over P: Each node runs doDecisionAlgorithm()
    A-&gt;&gt;P: onMutexAcknowledgementReceived(Ack_A) via RMI [Assume A grants OK]
    B-&gt;&gt;P: onMutexAcknowledgementReceived(Ack_B) via RMI [Assume B grants OK]
    P-&gt;&gt;P: onMutexAcknowledgementReceived(Ack_P) [Self Ack]

    P-&gt;&gt;P: areAllMessagesReturned() \-&gt; true
    P-&gt;&gt;P: acquireLock() [Enter CS]
    P-&gt;&gt;P: node.broadcastUpdatetoPeers(updates)
    P-&gt;&gt;P: releaseLocks() [Exit CS]
    P-&gt;&gt;A: releaseLocks() via RMI
    P-&gt;&gt;B: releaseLocks() via RMI
    P-&gt;&gt;P: sendQueuedAcknowledgements() [Notify any waiting nodes]

    Note over A,B: Peers receive releaseLocks() call, mark CS as free, send queued ACKs.</code></pre>
<p><em>Explanation:</em> Node P initiates the request, sending it to A, B, and itself. Each node decides whether to grant permission immediately or queue the request based on clocks and state. Assuming P gets priority, A and B send acknowledgments back. Once P receives all ACKs, it enters the critical section, performs the update broadcast, and then releases the lock by notifying A and B.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this final chapter, we explored <strong>Distributed Mutual Exclusion</strong>, a crucial protocol for coordinating access to shared resources like file replicas in a distributed system. We saw how the naive approach to updates could lead to conflicts (race conditions) when multiple nodes try to write concurrently.</p>
<p>We learned how nodes can act like a distributed traffic light system, using a <strong>voting mechanism</strong> based on <strong>Lamport clocks</strong> and <strong>Node IDs</strong> to ensure only one node enters the <strong>critical section</strong> (file update process) at a time. A node wanting access must request permission from all relevant peers and wait for acknowledgments before proceeding. After completing its update, it releases the "lock," allowing other waiting nodes to potentially acquire it. This ensures orderly, conflict-free updates even without a central coordinator.</p>
<p>Understanding these core concepts – from file replication and node management to communication, hashing, network structure (Chord), message passing, consistency protocols, and finally, mutual exclusion – provides a solid foundation for building robust and reliable distributed systems like the one in <code>DAT110-project3</code>. Congratulations on completing the tutorial!</p>
<hr/>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
</body>
</html>