
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../07_connection__network_stream_handling__/" rel="prev"/>
<link href="../test/" rel="next"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.12" name="generator"/>
<title>Chapter 8: MessageUtils (Serialization/Deserialization) - dat110 notes</title>
<link href="../assets/stylesheets/main.2afb09e1.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#chapter-8-messageutils-serializationdeserialization">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="dat110 notes" class="md-header__button md-logo" data-md-component="logo" href=".." title="dat110 notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            dat110 notes
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Chapter 8: MessageUtils (Serialization/Deserialization)
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="dat110 notes" class="md-nav__button md-logo" data-md-component="logo" href=".." title="dat110 notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    dat110 notes
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    Tutorial: dat110-project2-javafx-chatapp
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../01_message_hierarchy__communication_protocol__/">
<span class="md-ellipsis">
    Chapter 1: Message Hierarchy (Communication Protocol)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../02_client__network_interaction_logic__/">
<span class="md-ellipsis">
    Chapter 2: Client (Network Interaction Logic)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../03_chapp__application_entry_point__/">
<span class="md-ellipsis">
    Chapter 3: Chapp (Application Entry Point)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../04_ui_areas__commandarea___messagearea__/">
<span class="md-ellipsis">
    Chapter 4: UI Areas (CommandArea &amp; MessageArea)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../05_controller__ui_logic_coordinator__/">
<span class="md-ellipsis">
    Chapter 5: Controller (UI Logic Coordinator)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../06_transportmessage__network_data_framing__/">
<span class="md-ellipsis">
    Chapter 6: TransportMessage (Network Data Framing)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../07_connection__network_stream_handling__/">
<span class="md-ellipsis">
    Chapter 7: Connection (Network Stream Handling)
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Chapter 8: MessageUtils (Serialization/Deserialization)
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Chapter 8: MessageUtils (Serialization/Deserialization)
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-translator-and-packager-messageutils">
<span class="md-ellipsis">
      The Translator and Packager: MessageUtils
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#why-json-a-universal-language">
<span class="md-ellipsis">
      Why JSON? A Universal Language
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#using-gson-our-json-translator-tool">
<span class="md-ellipsis">
      Using GSON: Our JSON Translator Tool
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#serialization-object-json-bytes">
<span class="md-ellipsis">
      Serialization: Object -&gt; JSON -&gt; Bytes
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deserialization-bytes-json-object">
<span class="md-ellipsis">
      Deserialization: Bytes -&gt; JSON -&gt; Object
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#convenience-methods-send-and-receive">
<span class="md-ellipsis">
      Convenience Methods: send and receive
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#under-the-hood-gson-at-work">
<span class="md-ellipsis">
      Under the Hood: GSON at Work
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../test/">
<span class="md-ellipsis">
    Test
    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#the-translator-and-packager-messageutils">
<span class="md-ellipsis">
      The Translator and Packager: MessageUtils
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#why-json-a-universal-language">
<span class="md-ellipsis">
      Why JSON? A Universal Language
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#using-gson-our-json-translator-tool">
<span class="md-ellipsis">
      Using GSON: Our JSON Translator Tool
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#serialization-object-json-bytes">
<span class="md-ellipsis">
      Serialization: Object -&gt; JSON -&gt; Bytes
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deserialization-bytes-json-object">
<span class="md-ellipsis">
      Deserialization: Bytes -&gt; JSON -&gt; Object
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#convenience-methods-send-and-receive">
<span class="md-ellipsis">
      Convenience Methods: send and receive
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#under-the-hood-gson-at-work">
<span class="md-ellipsis">
      Under the Hood: GSON at Work
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="chapter-8-messageutils-serializationdeserialization">Chapter 8: MessageUtils (Serialization/Deserialization)</h1>
<p>Welcome to the final chapter of our core tutorial! In <a href="../07_connection__network_stream_handling__/">Chapter 7: Connection (Network Stream Handling)</a>, we saw how the <code>Connection</code> class acts like a delivery truck, sending and receiving standard-sized 128-byte packages (<code>TransportMessage</code> from <a href="../06_transportmessage__network_data_framing__/">Chapter 6</a>) over the network.</p>
<p>However, there's a crucial step we haven't fully explored. Inside those 128-byte packages are the raw <em>payload bytes</em>. When we <em>send</em> a message, how do we convert our meaningful Java <code>Message</code> objects (like <code>PublishMsg</code> from <a href="../01_message_hierarchy__communication_protocol__/">Chapter 1</a>) into those raw bytes? And when we <em>receive</em> a package, how do we turn the payload bytes back into a usable <code>Message</code> object that our application logic (<a href="../05_controller__ui_logic_coordinator__/">Chapter 5: Controller</a>) can understand?</p>
<p>This conversion process is like translating between languages – the language of our Java application (objects) and the language of the network (bytes).</p>
<h2 id="the-translator-and-packager-messageutils">The Translator and Packager: <code>MessageUtils</code></h2>
<p>Imagine you want to send a detailed instruction manual (our <code>Message</code> object) to someone overseas. You can't just beam the manual directly!
1.  <strong>Translate:</strong> You might first translate it into a universally understood format, like simple English or maybe a standard code (like JSON).
2.  <strong>Package:</strong> Then, you need to write this translated version down onto paper (convert to bytes) and put it in a standard shipping box (<code>TransportMessage</code>).</p>
<p>When the person receives the box, they do the reverse:
1.  <strong>Unpack:</strong> They take the paper out of the box.
2.  <strong>Translate Back:</strong> They read the standard format and reconstruct the original instruction manual in their own language.</p>
<p>The <code>MessageUtils</code> class (<code>MessageUtils.java</code>) acts as our application's <strong>translator and packager</strong>. It's a collection of helper tools (static methods) specifically designed to:</p>
<ul>
<li><strong>Serialize:</strong> Convert a <code>Message</code> object into a standard format (JSON string) and then into raw bytes, ready to be put into a <code>TransportMessage</code> for sending.</li>
<li><strong>Deserialize:</strong> Take raw bytes received from a <code>TransportMessage</code>, convert them back into the standard format (JSON string), and then reconstruct the original <code>Message</code> object.</li>
</ul>
<h2 id="why-json-a-universal-language">Why JSON? A Universal Language</h2>
<p>Instead of inventing our own complex way to represent message objects as bytes, we use a popular, standard format called <strong>JSON (JavaScript Object Notation)</strong>.</p>
<p>JSON is human-readable text that uses key-value pairs. A <code>PublishMsg</code> object might look like this in JSON:</p>
<pre><code class="language-json">{
  "type": "PUBLISH",
  "user": "Alice",
  "topic": "general",
  "message": "Hello there!"
}
</code></pre>
<p>Why use JSON?
*   <strong>Readable:</strong> Humans can easily read and understand it (great for debugging!).
*   <strong>Standard:</strong> Many programming languages and systems understand JSON, making it great for communication.
*   <strong>Simple:</strong> It's relatively easy to convert Java objects to and from JSON.</p>
<h2 id="using-gson-our-json-translator-tool">Using GSON: Our JSON Translator Tool</h2>
<p>To handle the conversion between our Java <code>Message</code> objects and JSON strings, we use a popular Java library called <strong>GSON</strong> (from Google). Think of GSON as a specialized translator that knows how to read Java object fields (like <code>user</code>, <code>topic</code>) and write them into JSON format, and vice-versa.</p>
<p>You'll notice <code>import com.google.gson.*;</code> at the top of <code>MessageUtils.java</code> - that's us bringing in the GSON library.</p>
<h2 id="serialization-object-json-bytes">Serialization: Object -&gt; JSON -&gt; Bytes</h2>
<p>Let's see how <code>MessageUtils</code> handles serialization when we want to send a message.</p>
<p><strong>Step 1: Object to JSON String (<code>toJson</code>)</strong></p>
<p>This method takes any <code>Message</code> object and uses GSON to turn it into a JSON string.</p>
<pre><code class="language-java">// File: src/main/java/no/hvl/dat110/messages/MessageUtils.java

import com.google.gson.Gson; // Import the GSON library

// ... other imports ...

public class MessageUtils {

    public static String toJson(Message msg) {
        // Create a GSON translator instance
        Gson gson = new Gson();
        // Tell GSON to convert the Message object into a JSON string
        String json = gson.toJson(msg);
        // Return the resulting JSON string
        return json;
    }

    // ... other methods ...
}
</code></pre>
<ul>
<li>Input: A <code>Message</code> object (e.g., <code>new PublishMsg("Alice", "general", "Hello!")</code>).</li>
<li>Output: A JSON string (e.g., <code>{"type":"PUBLISH","user":"Alice","topic":"general","message":"Hello there!"}</code>).</li>
<li>How: It simply uses <code>gson.toJson(msg)</code>. GSON automatically looks at the fields in the <code>msg</code> object and creates the corresponding JSON structure.</li>
</ul>
<p><strong>Step 2: JSON String to Bytes (<code>getBytes</code>)</strong></p>
<p>Now that we have the JSON string, we need to convert it into the raw bytes that can be sent over the network. Java strings have a built-in method for this.</p>
<pre><code class="language-java">// File: src/main/java/no/hvl/dat110/messages/MessageUtils.java

public class MessageUtils {

    // ... toJson method ...

    public static byte[] getBytes(Message msg) {
        // First, convert the Message object to a JSON string
        String jsonString = toJson(msg);
        // Then, convert the string into an array of bytes
        // using the default character encoding (usually UTF-8)
        byte[] bytes = jsonString.getBytes();
        // Return the byte array
        return bytes;
    }

    // ... other methods ...
}
</code></pre>
<ul>
<li>Input: A <code>Message</code> object.</li>
<li>Output: A <code>byte[]</code> array representing the JSON string.</li>
<li>How: It calls <code>toJson()</code> first, then calls the standard Java <code>.getBytes()</code> method on the resulting string.</li>
</ul>
<p><strong>Step 3: Bytes into a TransportMessage (<code>toTransportMessage</code>)</strong></p>
<p>Finally, we take these bytes and put them into the <code>TransportMessage</code> frame we learned about in <a href="../06_transportmessage__network_data_framing__/">Chapter 6</a>.</p>
<pre><code class="language-java">// File: src/main/java/no/hvl/dat110/messages/MessageUtils.java

import no.hvl.dat110.messagetransport.TransportMessage; // Import TransportMessage

// ... other imports ...

public class MessageUtils {

    // ... toJson, getBytes methods ...

    public static TransportMessage toTransportMessage(Message msg) {
        // 1. Convert the Message object to bytes (via JSON)
        byte[] payloadBytes = getBytes(msg);
        // 2. Create a new TransportMessage containing these bytes as payload
        TransportMessage transportMsg = new TransportMessage(payloadBytes);
        // Return the prepared TransportMessage
        return transportMsg;
    }

    // ... other methods ...
}
</code></pre>
<ul>
<li>Input: A <code>Message</code> object.</li>
<li>Output: A <code>TransportMessage</code> object ready to be sent by the <code>Connection</code>.</li>
<li>How: It calls <code>getBytes()</code> to get the payload, then creates a <code>new TransportMessage()</code> using those bytes.</li>
</ul>
<p>This <code>toTransportMessage</code> method is the primary serialization helper used by the <code>Client</code> before sending.</p>
<h2 id="deserialization-bytes-json-object">Deserialization: Bytes -&gt; JSON -&gt; Object</h2>
<p>Now let's look at the reverse process when we receive data. The <code>Connection</code> gives us a <code>TransportMessage</code> containing payload bytes.</p>
<p><strong>Step 1: Extract Bytes from TransportMessage (<code>fromTransportMessage</code>)</strong></p>
<p>This method takes the received <code>TransportMessage</code> and extracts the raw payload bytes.</p>
<pre><code class="language-java">// File: src/main/java/no/hvl/dat110/messages/MessageUtils.java

public class MessageUtils {

    // ... serialization methods ...

    public static Message fromTransportMessage(TransportMessage msg) {
        // 1. Get the raw payload bytes from the TransportMessage
        byte[] payloadBytes = msg.getData();
        // 2. Convert these bytes back into a Message object
        Message originalMessage = fromBytes(payloadBytes);
        // Return the reconstructed Message object
        return originalMessage;
    }

    // ... other methods ...
}
</code></pre>
<ul>
<li>Input: A <code>TransportMessage</code> received from the <code>Connection</code>.</li>
<li>Output: The reconstructed <code>Message</code> object.</li>
<li>How: It calls <code>msg.getData()</code> to get the payload bytes, then passes these bytes to the <code>fromBytes</code> method (explained next).</li>
</ul>
<p><strong>Step 2: Bytes to JSON String (<code>fromBytes</code>)</strong></p>
<p>This method takes the raw bytes and converts them back into a JSON string.</p>
<pre><code class="language-java">// File: src/main/java/no/hvl/dat110/messages/MessageUtils.java

public class MessageUtils {

    // ... fromTransportMessage method ...

    public static Message fromBytes(byte[] payload) {
        // Convert the byte array back into a String
        String jsonString = new String(payload);
        // Convert the JSON string into a Message object
        Message message = fromJson(jsonString);
        // Return the reconstructed object
        return message;
    }

    // ... fromJson method ...
}
</code></pre>
<ul>
<li>Input: A <code>byte[]</code> array (the payload).</li>
<li>Output: A <code>Message</code> object.</li>
<li>How: It uses <code>new String(payload)</code> to turn the bytes back into a string (assuming the same character encoding, usually UTF-8). Then, it calls <code>fromJson()</code> (explained next) to parse this string.</li>
</ul>
<p><strong>Step 3: JSON String to Object (<code>fromJson</code>)</strong></p>
<p>This is the core of deserialization where GSON reconstructs the specific <code>Message</code> object. Since the JSON only tells us the <code>type</code> (like "PUBLISH"), we need to help GSON figure out <em>which</em> Java class to create (<code>PublishMsg</code>, <code>ConnectMsg</code>, etc.).</p>
<pre><code class="language-java">// File: src/main/java/no/hvl/dat110/messages/MessageUtils.java

import com.google.gson.*; // Need more GSON classes here
import no.hvl.dat110.messages.MessageType; // Need the enum

// ... other imports ...

public class MessageUtils {

    // ... fromBytes method ...

    public static Message fromJson(String msgJson) {

        // 1. Parse the raw JSON string into a generic JSON object structure
        JsonParser jsonParser = new JsonParser();
        JsonObject json = jsonParser.parse(msgJson).getAsJsonObject();

        // 2. Look inside the JSON to find the "type" field's value
        String typestr = json.get("type").getAsString(); // e.g., "PUBLISH"

        // 3. Convert the type string into our MessageType enum
        MessageType type = MessageType.valueOf(typestr); // e.g., MessageType.PUBLISH

        // 4. Create a GSON instance
        Gson gson = new Gson();
        Message message = null; // Variable to hold the final object

        // 5. Use a switch based on the type to tell GSON which class to build
        switch (type) {
            case CONNECT:
                message = gson.fromJson(json, ConnectMsg.class);
                break;
            case PUBLISH:
                message = gson.fromJson(json, PublishMsg.class);
                break;
            case SUBSCRIBE:
                message = gson.fromJson(json, SubscribeMsg.class);
                break;
            // ... cases for all other MessageTypes ...
            default:
                System.out.println("fromJson - unknown message type: " + typestr);
                break;
        }

        // Return the specific Message object (e.g., a PublishMsg instance)
        return message;
    }

    // ... other methods ...
}
</code></pre>
<ul>
<li>Input: A JSON string (e.g., <code>{"type":"PUBLISH","user":"Alice",...}</code>).</li>
<li>Output: A specific <code>Message</code> object (e.g., a <code>PublishMsg</code> instance).</li>
<li>How:<ul>
<li>It first parses the string into a general <code>JsonObject</code>.</li>
<li>It extracts the value of the <code>"type"</code> field.</li>
<li>It uses a <code>switch</code> statement based on this type.</li>
<li>Inside the correct <code>case</code>, it calls <code>gson.fromJson(json, SpecificMsgClass.class)</code>. This tells GSON: "Take the data from this <code>json</code> object and use it to create an instance of <em>this specific class</em> (e.g., <code>PublishMsg.class</code>)". GSON automatically matches JSON fields to the Java class fields.</li>
</ul>
</li>
</ul>
<p>This <code>fromTransportMessage</code> (which uses <code>fromBytes</code> and <code>fromJson</code>) is the primary deserialization helper used by the <code>Client</code> after receiving data.</p>
<h2 id="convenience-methods-send-and-receive">Convenience Methods: <code>send</code> and <code>receive</code></h2>
<p><code>MessageUtils</code> also provides two high-level convenience methods that combine the translation step with the actual network sending/receiving.</p>
<pre><code class="language-java">// File: src/main/java/no/hvl/dat110/messages/MessageUtils.java

import no.hvl.dat110.messagetransport.Connection; // Need Connection

// ... other imports ...

public class MessageUtils {

    // ... all the conversion methods ...

    // Sends a Message object over a Connection
    public static void send (Connection connection, Message message) {
        // 1. Convert the Message object to a TransportMessage
        TransportMessage transportMsg = toTransportMessage(message);
        // 2. Tell the connection to send it
        connection.send(transportMsg);
    }

    // Receives the next Message object from a Connection
    public static Message receive (Connection connection) {
        // 1. Tell the connection to receive the next 128-byte frame
        TransportMessage transportMsg = connection.receive();
        // 2. If successful, convert the TransportMessage back to a Message object
        Message message = null;
        if (transportMsg != null) {
            message = fromTransportMessage(transportMsg);
        }
        // Return the reconstructed Message object (or null if receive failed)
        return message;
    }
}
</code></pre>
<ul>
<li><code>send(connection, message)</code>: A shortcut that takes your <code>Message</code> object, serializes it into a <code>TransportMessage</code> using <code>toTransportMessage</code>, and then calls <code>connection.send()</code> to send it over the network.</li>
<li><code>receive(connection)</code>: A shortcut that calls <code>connection.receive()</code> to get the next <code>TransportMessage</code>, and if successful, deserializes it back into the original <code>Message</code> object using <code>fromTransportMessage</code>.</li>
</ul>
<p>The <code>Client</code> primarily uses these <code>send</code> and <code>receive</code> methods for cleaner code.</p>
<h2 id="under-the-hood-gson-at-work">Under the Hood: GSON at Work</h2>
<p>Let's visualize the core GSON translation steps.</p>
<p><strong>Serialization (<code>toJson</code>):</strong></p>
<div class="mermaid">sequenceDiagram
    participant Client as Client Code
    participant MU as MessageUtils
    participant GSON as GSON Library
    participant PubMsg as PublishMsg Object

    Client-&gt;&gt;MU: toJson(myPublishMsg)
    Note right of Client: myPublishMsg has user="Alice", topic="news", ...
    MU-&gt;&gt;GSON: gson.toJson(myPublishMsg)
    GSON-&gt;&gt;PubMsg: Read field 'type' (PUBLISH)
    GSON-&gt;&gt;PubMsg: Read field 'user' ("Alice")
    GSON-&gt;&gt;PubMsg: Read field 'topic' ("news")
    GSON-&gt;&gt;PubMsg: Read field 'message' ("Hello")
    GSON--&gt;&gt;MU: Return JSON String: "{\"type\":\"PUBLISH\",\"user\":\"Alice\",...}"
    MU--&gt;&gt;Client: Return JSON String
</div>
<p><strong>Deserialization (<code>fromJson</code> for a PublishMsg):</strong></p>
<div class="mermaid">sequenceDiagram
    participant Client as Client Code
    participant MU as MessageUtils
    participant Parser as JsonParser
    participant GSON as GSON Library

    Client-&gt;&gt;MU: fromJson("{\"type\":\"PUBLISH\",\"user\":\"Alice\",...}")
    MU-&gt;&gt;Parser: parser.parse(jsonString)
    Parser--&gt;&gt;MU: Return JsonObject 'json'
    MU-&gt;&gt;MU: Get type from json ("PUBLISH")
    MU-&gt;&gt;MU: Switch -&gt; case PUBLISH:
    MU-&gt;&gt;GSON: gson.fromJson(json, PublishMsg.class)
    GSON-&gt;&gt;GSON: Create new empty PublishMsg object
    GSON-&gt;&gt;GSON: Find "user" in json, set object.user = "Alice"
    GSON-&gt;&gt;GSON: Find "topic" in json, set object.topic = "news"
    GSON-&gt;&gt;GSON: Find "message" in json, set object.message = "Hello"
    GSON--&gt;&gt;MU: Return populated PublishMsg object
    MU--&gt;&gt;Client: Return Message object (as PublishMsg)
</div>
<h2 id="conclusion">Conclusion</h2>
<p>The <code>MessageUtils</code> class is the essential translator between our application's Java <code>Message</code> objects and the raw bytes needed for network transmission.</p>
<ul>
<li>It uses the <strong>JSON</strong> format as a standard, readable intermediate representation.</li>
<li>It relies on the <strong>GSON library</strong> to perform the actual conversion between Java objects and JSON strings.</li>
<li><strong>Serialization (<code>toTransportMessage</code>)</strong>: Converts <code>Message</code> -&gt; JSON String -&gt; <code>byte[]</code> -&gt; <code>TransportMessage</code>.</li>
<li><strong>Deserialization (<code>fromTransportMessage</code>)</strong>: Converts <code>TransportMessage</code> -&gt; <code>byte[]</code> -&gt; JSON String -&gt; <code>Message</code>.</li>
<li>The <code>fromJson</code> method uses the <code>"type"</code> field within the JSON to determine which specific <code>Message</code> subclass to create.</li>
<li>Helper methods <code>send</code> and <code>receive</code> simplify the process for the <code>Client</code>.</li>
</ul>
<p>With <code>MessageUtils</code>, we complete the communication pipeline. We can now create message objects, translate and package them, send them over the network using the connection, receive packages, and translate them back into objects the application can understand.</p>
<p>This concludes our tour of the core components of the <code>dat110-project2-javafx-chatapp</code> client! We've covered the message structure, client logic, application entry point, UI areas, controller, network framing, connection handling, and finally, the serialization/deserialization mechanism. You now have a foundational understanding of how these pieces work together to create a functional chat client.</p>
<hr/>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>